# This file is a template, and might need editing before it works on your project.
# Template project: https://gitlab.com/pages/jekyll
# Docs: https://docs.gitlab.com/ce/pages/

variables:
  JEKYLL_ENV: production
  LC_ALL: C.UTF-8

stages:
  - test
  - build
  - deploy

behat:
  stage: test
  # when: manual
  # Select image from https://hub.docker.com/_/php/
  image: php:7.3.11
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: '$CI_COMMIT_TAG'
      when: never
    - when: always
  before_script:
    - apt-get update
    - curl -sL https://deb.nodesource.com/setup_10.x | bash -
    - apt-get --yes install git zip unzip nodejs
    - nodejs --version
    - npm --version
    - npm install
    - ./node_modules/.bin/drakov --stealthmode -f "./spec/*.apib" -p 3000&
    - php -v
    - php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
    - php composer-setup.php
    - php -r "unlink('composer-setup.php');"
    - php composer.phar install
  script:
    - vendor/bin/behat --suite=core
  allow_failure: false
  cache:
    key: behat
    paths:
      - node_modules/
      - vendor/

build-docs:
  stage: build
  image: ruby:2.6
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - when: on_success
  before_script:
    - apt-get update
    - curl -sL https://deb.nodesource.com/setup_10.x | bash -
    - apt-get --yes install git zip unzip nodejs
    - nodejs --version
    - npm --version
    - npm install
    - cd docs
    - gem install bundler
    - bundle -v
    - bundle config path 'vendor'
    - bundle install
    - echo $(date -u)
  script:
    - bundle exec jekyll build --destination ../public/
    - cd ..
    - mkdir -p ./public/spec/core
    - echo "Render HTML for 0.16"
    - cp -r ./spec ./public/spec/core/0.16
    - node_modules/.bin/aglio -i ./public/spec/core/0.16/apiary.apib --no-theme-condense --theme-full-width -o ./public/spec/core/0.16/index.html
    - echo "Render HTML for next version"
    - git fetch origin develop
    - git checkout develop -- ./spec
    - cp -r ./spec ./public/spec/core/next
    - git reset HEAD ./spec
    - git checkout -- ./spec
    - node_modules/.bin/aglio -i ./public/spec/core/next/apiary.apib --no-theme-condense --theme-full-width -o ./public/spec/core/next/index.html
    - echo "Render HTML for 0.15"
    - git checkout 0.15.2 -- apiary.apib
    - mkdir -p ./public/spec/core/0.15
    - mv ./apiary.apib ./public/spec/core/0.15/apiary.apib
    - node_modules/.bin/aglio -i ./public/spec/core/0.15/apiary.apib --no-theme-condense --theme-full-width -o ./public/spec/core/0.15/index.html
    - echo "Render HTML for 0.14"
    - git checkout 0.14 -- apiary.apib
    - mkdir -p ./public/spec/core/0.14
    - mv ./apiary.apib ./public/spec/core/0.14/apiary.apib
    - node_modules/.bin/aglio -i ./public/spec/core/0.14/apiary.apib --no-theme-condense --theme-full-width -o ./public/spec/core/0.14/index.html
    - echo "Render HTML for 0.13"
    - git checkout 0.13 -- apiary.apib
    - mkdir -p ./public/spec/core/0.13
    - mv ./apiary.apib ./public/spec/core/0.13/apiary.apib
    - node_modules/.bin/aglio -i ./public/spec/core/0.13/apiary.apib --no-theme-condense --theme-full-width -o ./public/spec/core/0.13/index.html

  cache:
    key: build
    paths:
      - docs/vendor
  artifacts:
    paths:
      - public

pages:
  stage: deploy
  rules:
    - if: $CI_MERGE_REQUEST_ID
      when: never
    - if: '$CI_COMMIT_TAG'
      when: on_success
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: manual
    - when: never
  script:
    - ls -al
  artifacts:
    paths:
      - public
